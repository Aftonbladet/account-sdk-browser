<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>monetization.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Identity.html">Identity</a><ul class='methods'><li data-type='method'><a href="Identity.html#enableVarnishCookie">enableVarnishCookie</a></li><li data-type='method'><a href="Identity.html#hasSession">hasSession</a></li><li data-type='method'><a href="Identity.html#isLoggedIn">isLoggedIn</a></li><li data-type='method'><a href="Identity.html#isConnected">isConnected</a></li><li data-type='method'><a href="Identity.html#getUser">getUser</a></li><li data-type='method'><a href="Identity.html#getUserId">getUserId</a></li><li data-type='method'><a href="Identity.html#getUserUuid">getUserUuid</a></li><li data-type='method'><a href="Identity.html#getSpId">getSpId</a></li><li data-type='method'><a href="Identity.html#login">login</a></li><li data-type='method'><a href="Identity.html#logout">logout</a></li><li data-type='method'><a href="Identity.html#loginUrl">loginUrl</a></li><li data-type='method'><a href="Identity.html#logoutUrl">logoutUrl</a></li><li data-type='method'><a href="Identity.html#accountUrl">accountUrl</a></li><li data-type='method'><a href="Identity.html#phonesUrl">phonesUrl</a></li><li data-type='method'><a href="Identity.html#authFlowUrl">authFlowUrl</a></li><li data-type='method'><a href="Identity.html#signupFlowUrl">signupFlowUrl</a></li><li data-type='method'><a href="Identity.html#signinFlowUrl">signinFlowUrl</a></li><li data-type='method'><a href="Identity.html#showItpModalUponReturning">showItpModalUponReturning</a></li><li data-type='method'><a href="Identity.html#suppressItpModal">suppressItpModal</a></li></ul></li><li><a href="Monetization.html">Monetization</a><ul class='methods'><li data-type='method'><a href="Monetization.html#hasProduct">hasProduct</a></li><li data-type='method'><a href="Monetization.html#hasSubscription">hasSubscription</a></li><li data-type='method'><a href="Monetization.html#subscriptionsUrl">subscriptionsUrl</a></li><li data-type='method'><a href="Monetization.html#productsUrl">productsUrl</a></li></ul></li><li><a href="Payment.html">Payment</a><ul class='methods'><li data-type='method'><a href="Payment.html#payWithPaylink">payWithPaylink</a></li><li data-type='method'><a href="Payment.html#purchaseHistoryUrl">purchaseHistoryUrl</a></li><li data-type='method'><a href="Payment.html#redeemUrl">redeemUrl</a></li><li data-type='method'><a href="Payment.html#purchasePaylinkUrl">purchasePaylinkUrl</a></li><li data-type='method'><a href="Payment.html#purchaseProductFlowUrl">purchaseProductFlowUrl</a></li><li data-type='method'><a href="Payment.html#purchaseCampaignFlowUrl">purchaseCampaignFlowUrl</a></li><li data-type='method'><a href="Payment.html#purchasePromoCodeProductFlowUrl">purchasePromoCodeProductFlowUrl</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="Identity.html#event:error">error</a></li><li><a href="Identity.html#event:login">login</a></li><li><a href="Identity.html#event:logout">logout</a></li><li><a href="Identity.html#event:userChange">userChange</a></li><li><a href="Identity.html#event:sessionChange">sessionChange</a></li><li><a href="Identity.html#event:notLoggedin">notLoggedin</a></li><li><a href="Identity.html#event:sessionInit">sessionInit</a></li><li><a href="Identity.html#event:statusChange">statusChange</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">monetization.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* Copyright 2018 Schibsted Products &amp; Technology AS. Licensed under the terms of the MIT license.
 * See LICENSE.md in the project root.
 */

'use strict';

import { assert, isStr, isNonEmptyString, isUrl } from './validate';
import { urlMapper } from './url';
import { ENDPOINTS, NAMESPACE } from './config';
import EventEmitter from 'tiny-emitter';
import JSONPClient from './JSONPClient';
import RESTClient from './RESTClient';
import Cache from './cache';
import * as spidTalk from './spidTalk';

const DEFAULT_CACHE_NO_ACCESS = 10; // 10 seconds
const DEFAULT_CACHE_HAS_ACCESS = 1 * 60 * 60; // 1 hour
const globalWindow = () => window;

/**
 * Provides features related to monetization
 */
export class Monetization extends EventEmitter {
    /**
     * @param {object} options
     * @param {string} options.clientId - Mandatory client id
     * @param {string} [options.redirectUri] - Redirect uri
     * @param {string} [options.env=PRE] - Schibsted account environment: `PRE`, `PRO` or `PRO_NO`
     * @param {string} [options.sessionDomain] - Example: "https://id.site.com"
     * @throws {SDKError} - If any of options are invalid
     */
    constructor({ clientId, redirectUri, env = 'PRE', sessionDomain, window = globalWindow() }) {
        super();
        spidTalk.emulate(window);
        // validate options
        assert(isNonEmptyString(clientId), 'clientId parameter is required');

        this.cache = new Cache(() => window &amp;&amp; window.sessionStorage);
        this.clientId = clientId;
        this.env = env;
        this.redirectUri = redirectUri;
        this._setSpidServerUrl(env);

        if (sessionDomain) {
            assert(isUrl(sessionDomain), 'sessionDomain parameter is not a valid URL');
            this._setSessionServiceUrl(sessionDomain);
        }
    }

    /**
     * Set SPiD server URL
     * @private
     * @param {string} url
     * @returns {void}
     */
    _setSpidServerUrl(url) {
        assert(isStr(url), `url parameter is invalid: ${url}`);
        this._spid = new JSONPClient({
            serverUrl: urlMapper(url, ENDPOINTS.SPiD),
            defaultParams: { client_id: this.clientId, redirect_uri: this.redirectUri },
        });
    }

    /**
     * Set session-service domain
     * @private
     * @param {string} domain - real URL â€” (**not** 'PRE' style env key)
     * @returns {void}
     */
    _setSessionServiceUrl(domain) {
        assert(isStr(domain), `domain parameter is invalid: ${domain}`);
        const client_sdrn = `sdrn:${NAMESPACE[this.env]}:client:${this.clientId}`;
        this._sessionService = new RESTClient({
            serverUrl: domain,
            log: this.log,
            defaultParams: { client_sdrn, redirect_uri: this.redirectUri },
        });
    }

    /**
     * Checks if the user has access to a particular product
     * @param {string} productId
     * @param {string} spId - The spId that was obtained from {@link Identity#getSpId}
     * @throws {SDKError} - If a network call fails in any way (this will happen if, say, the user
     * is not logged in)
     * @returns {Object|null} The data object returned from Schibsted account (or `null` if the user
     * doesn't have access to the given product)
     */
    async hasProduct(productId, spId) {
        const cacheKey = `prd_${productId}_${spId}`;
        let data = this.cache.get(cacheKey);
        const shouldCache = !data;
        if (!data &amp;&amp; this._sessionService) {
            try {
                data = await this._sessionService.get(`/hasProduct/${productId}`);
            } catch (err) {
                // The session-service returns 400 if no session-cookie is sent in the request. This
                // will be the case if the user hasn't logged in since the site switched to using
                // the session-service. If the request contains a session-cookie but an error is
                // still thrown, then we *should* throw an exception and *not* fall through to
                // spid
                if (err.code !== 400) {
                    throw err;
                }
                data = null;
            }
        }
        if (!data) {
            const params = { product_id: productId }
            if (spId) {
                params.sp_id = spId;
            }
            data = await this._spid.get('ajax/hasproduct.js', params);
        }
        if (shouldCache) {
            const expiresSeconds = data.result ? DEFAULT_CACHE_HAS_ACCESS : DEFAULT_CACHE_NO_ACCESS;
            this.cache.set(cacheKey, data, expiresSeconds * 1000);
        }
        if (!data.result) {
            return null;
        }
        this.emit('hasProduct', { productId, data });
        return data;
    }

    /**
     * Checks if the user has access to a particular subscription
     * @param {string} subscriptionId
     * @param {string} spId - The spId that was obtained from {@link Identity#getSpId}
     * @throws {SDKError} - If a network call fails in any way (this will happen if, say, the user
     * is not logged in)
     * @returns {Object|null} The data object returned from Schibsted account (or `null` if the user
     * doesn't have access to the given subscription)
     */
    async hasSubscription(subscriptionId, spId) {
        const cacheKey = `sub_${subscriptionId}_${spId}`;
        let data = this.cache.get(cacheKey);
        const shouldCache = !data;
        if (!data &amp;&amp; this._sessionService) {
            try {
                data = await this._sessionService.get(`/hasSubscription/${subscriptionId}`);
            } catch (err) {
                // The session-service returns 400 if no session-cookie is sent in the request. This
                // will be the case if the user hasn't logged in since the site switched to using
                // the session-service. If the request contains a session-cookie but an error is
                // still thrown, then we *should* throw an exception and *not* fall through to
                // spid
                if (err.code !== 400) {
                    throw err;
                }
                data = null;
            }
        }
        if (!data) {
            const params = { product_id: subscriptionId }
            if (spId) {
                params.sp_id = spId;
            }
            data = await this._spid.get('ajax/hassubscription.js', params);
        }
        if (shouldCache) {
            const expiresSeconds = data.result ? DEFAULT_CACHE_HAS_ACCESS : DEFAULT_CACHE_NO_ACCESS;
            this.cache.set(cacheKey, data, expiresSeconds * 1000);
        }
        if (!data.result) {
            return null;
        }
        this.emit('hasSubscription', { subscriptionId, data });
        return data;
    }

    /**
     * Get the url for the end user to review the subscriptions
     * @param {string} [redirectUri=this.redirectUri]
     * @return {string} - The url to the subscriptions review page
     */
    subscriptionsUrl(redirectUri = this.redirectUri) {
        assert(isUrl(redirectUri), `subscriptionsUrl(): redirectUri is invalid`);
        return this._spid.makeUrl('account/subscriptions', { redirect_uri: redirectUri });
    }

    /**
     * Get the url for the end user to review the products
     * @param {string} [redirectUri=this.redirectUri]
     * @return {string} - The url to the products review page
     */
    productsUrl(redirectUri = this.redirectUri) {
        assert(isUrl(redirectUri), `productsUrl(): redirectUri is invalid`);
        return this._spid.makeUrl('account/products', { redirect_uri: redirectUri });
    }
}

export default Monetization;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Jan 28 2019 12:04:40 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
